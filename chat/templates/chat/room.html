<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room: [ROOM_NAME_PLACEHOLDER]</title>
    
    <style>
        /* CSS Styles */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            padding: 20px;
        }

        #chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }

        #chat-log {
            height: 400px;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            overflow-y: scroll;
            background-color: #f9f9f9;
        }

        #message-form-container {
            display: flex;
            margin-bottom: 10px;
        }

        #chat-message-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px 0 0 4px;
        }

        #chat-message-submit {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 0 4px 4px 0;
        }

        #upload-form button {
            padding: 8px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            margin-left: 10px;
        }

        .feedback-box {
            margin-top: 10px;
            padding: 5px;
            border: 1px dashed #ccc;
            font-size: 0.9em;
        }

        /* Styles for the received messages */
        #chat-log div {
            padding: 5px 0;
            border-bottom: 1px dotted #eee;
        }

        /* Style for the profanity warning message */
        #chat-log div[style*="#ffdddd"] {
            background-color: #ffdddd !important; 
            border-left: 5px solid red;
            padding-left: 5px;
        }
    </style>
</head>
<body>

    <h2>Room: [ROOM_NAME_PLACEHOLDER]</h2>
    <hr>

    <div id="chat-container">
        <div id="chat-log"></div>

        <div id="message-form-container">
            <input id="chat-message-input" type="text" size="100" placeholder="Type your message here...">
            <button id="chat-message-submit">Send</button>
        </div>
        
        <hr>

        <form id="upload-form" enctype="multipart/form-data">
            <h3>Share a File (PDF, TXT)</h3>
            <input type="file" name="file" accept=".pdf,.txt" required />
            <button type="submit">Upload</button>
        </form>

        <div id="message-box" class="feedback-box"></div>
        <div id="download-link" class="feedback-box"></div>
    </div>

  <script>
    // -------------------------------------------------------------------------
    // Variable Setup (Replace placeholder if using in Django)
    // -------------------------------------------------------------------------
    
    // IMPORTANT: If running this in a Django template, set this variable:
    // const roomName = "{{ room_name }}";
    // If testing standalone, set a static value:
    const roomName = "blue"; // Placeholder static room name for testing
    
    const chatLog = document.querySelector("#chat-log");

    // -------------------------------------------------------------------------
    // Utility Functions (CSRF Token & Decryption)
    // -------------------------------------------------------------------------

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function decryptAndRedirect(encryptedLink) {
        const csrftoken = getCookie('csrftoken');
        if (!csrftoken) {
            alert('Security error: Missing CSRF token.');
            return;
        }

        try {
            // Note: For decryption, X-CSRFToken header is used because JSON is sent
            const response = await fetch('/chat/decrypt_link/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken 
                },
                body: JSON.stringify({ encrypted_link: encryptedLink })
            });
            
            const data = await response.json();
            
            if (data.success && data.file_url) {
                window.open(data.file_url, '_blank');
            } else {
                alert('File access failed: Invalid or expired link.');
            }

        } catch (error) {
            console.error("Decryption/Fetch Error:", error);
            alert('Could not connect to the decryption server.');
        }
    }


    // -------------------------------------------------------------------------
    // WebSocket Setup
    // -------------------------------------------------------------------------
    
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
    );

    // Handler for messages received via WebSocket
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        // 1. Handle regular text messages
        if (data.type === 'text') {
            const textMessageDiv = document.createElement('div');
            textMessageDiv.textContent = `${data.sender}: ${data.message}`;
            chatLog.appendChild(textMessageDiv);
        }

        // 2. Handle file upload messages (received by recipient)
        else if (data.type === 'file_upload' && data.encrypted_link) {
            const fileMessageDiv = document.createElement('div');
            let warningText = '';
            
            if (data.profanity_warning) {
                warningText = ' ⚠️ PROFANITY WARNING! ⚠️';
                fileMessageDiv.style.backgroundColor = '#ffdddd';
            }
            
            // Create the clickable link element (span acts like a button)
            const linkSpan = document.createElement('span');
            linkSpan.textContent = `[File: ${data.file_name}] - Click to Access`;
            linkSpan.style.cursor = 'pointer';
            linkSpan.style.textDecoration = 'underline';
            
            // Attach the decryption handler on click
            linkSpan.onclick = () => decryptAndRedirect(data.encrypted_link);

            fileMessageDiv.innerHTML = `<strong>${data.sender} uploaded:</strong> ${warningText} `;
            fileMessageDiv.appendChild(linkSpan);
            chatLog.appendChild(fileMessageDiv);
        }
        
        chatLog.scrollTop = chatLog.scrollHeight; // Auto-scroll to bottom
    };

    // -------------------------------------------------------------------------
    // Form Submission Handlers
    // -------------------------------------------------------------------------

    // 1. Regular Message Submission
    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        if (message.trim() === '') return;
        
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        messageInputDom.value = '';
    };
    
    // Allow pressing Enter key to send message
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.key === 'Enter') {
            document.querySelector('#chat-message-submit').click();
        }
    };


    // 2. File Upload Submission
    document.getElementById('upload-form').onsubmit = async function(e) {
        e.preventDefault();
        
        const fileInput = document.querySelector('input[type="file"]');
        if (fileInput.files.length === 0) {
            alert("Please select a file to upload.");
            return;
        }

        const formData = new FormData(this);
        const csrftoken = getCookie('csrftoken');

        // Check if token exists
        if (!csrftoken) {
            document.getElementById('message-box').textContent = 'ERROR: CSRF token not found. Please ensure your Django view renders {% csrf_token %} and the cookie is set.';
            document.getElementById('message-box').style.color = 'red';
            return;
        }

        // CRITICAL FIX: Add the room_name and CSRF token to the form data
        formData.append('room_name', roomName); 
        formData.append('csrfmiddlewaretoken', csrftoken); // <-- FIX APPLIED HERE

        const messageBox = document.getElementById('message-box');
        const linkBox = document.getElementById('download-link');
        
        messageBox.textContent = 'Uploading and processing file...';
        messageBox.style.color = 'orange';

        try {
            const response = await fetch('/chat/upload_file/', {
                method: 'POST',
                body: formData, // FormData contains the file, room name, and CSRF token
            });
            const data = await response.json();

            // Handle server errors (e.g., 403 Forbidden, 500 Internal Server Error)
            if (!response.ok || data.error) {
                messageBox.textContent = `Error: ${data.error || response.statusText}`;
                messageBox.style.color = 'red';
                linkBox.textContent = '';
                return;
            }

            // Sender feedback (successful upload)
            if (data.profanity_warning) {
                messageBox.textContent = 'Upload successful, but content contains profanity. A warning was sent to the chat.';
                messageBox.style.color = 'red';
            } else {
                messageBox.textContent = 'File uploaded and link sent to chat successfully.';
                messageBox.style.color = 'green';
            }
            
            // Display the encrypted link for the sender's reference (optional)
            if (data.file_url_sent) {
                linkBox.innerHTML = `Encrypted Link Sent: <code>${data.file_url_sent}</code>`;
            } else {
                linkBox.textContent = '';
            }

        } catch (error) {
            messageBox.textContent = 'A network error occurred during file upload. Check server connection.';
            console.error(error);
        }
    };

</script>
    </script>
</body>
</html>