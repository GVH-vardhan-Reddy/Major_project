<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room: {{ room_name }}</title>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; padding: 20px; }
        #chat-container { max-width: 900px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #chat-log { height: 450px; border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 15px; overflow-y: auto; background-color: #ffffff; border-radius: 8px; }
        
        /* Message Bubbles */
        .msg { margin-bottom: 12px; padding: 10px; border-radius: 8px; border-bottom: 1px solid #f0f0f0; }
        .sender-name { font-weight: bold; color: #007bff; margin-right: 8px; }
        
        /* Profanity Warning Style */
        .profane-alert { 
            background-color: #fff5f5 !important; 
            border-left: 5px solid #ff4d4d !important; 
            color: #b91c1c;
        }
        .warning-badge {
            background: #ff4d4d; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; font-weight: bold; margin-right: 10px;
        }

        #message-form-container { display: flex; gap: 10px; }
        #chat-message-input { flex-grow: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; }
        #chat-message-submit { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; }
        #upload-form { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .feedback-box { margin-top: 10px; font-size: 0.9em; font-weight: 500; }
    </style>
</head>
<body>

    <div id="chat-container">
        <h2>Room: {{ room_name }}</h2>
        <div id="chat-log"></div>

        <div id="message-form-container">
            <input id="chat-message-input" type="text" placeholder="Type a message...">
            <button id="chat-message-submit">Send</button>
        </div>
        
        <form id="upload-form">
            {% csrf_token %}
            <strong>AI-Protected File Sharing</strong> (PDF/TXT)<br><br>
            <input type="file" name="file" accept=".pdf,.txt" required />
            <button type="submit" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Upload & Scan</button>
        </form>

        <div id="message-box" class="feedback-box"></div>
    </div>

<script>
    const roomName = "{{ room_name }}";
    const chatLog = document.querySelector("#chat-log");

    // CSRF Utility
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Decryption API Call
    async function decryptAndRedirect(encryptedLink) {
        const response = await fetch('/chat/decrypt_link/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ encrypted_link: encryptedLink })
        });
        const data = await response.json();
        if (data.success) window.open(data.file_url, '_blank');
        else alert('Link expired or invalid.');
    }

    // WebSocket Connection
    const chatSocket = new WebSocket(`ws://${window.location.host}/ws/chat/${roomName}/`);

 // Inside templates/chat/room.html -> chatSocket.onmessage

chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const chatLog = document.querySelector("#chat-log");
    const msgDiv = document.createElement('div');
    
    // Styling
    msgDiv.style.padding = "10px";
    msgDiv.style.borderBottom = "1px solid #eee";
    msgDiv.style.color = "#000";

    // Handle the AI warning background
    if (data.profanity_warning) {
        msgDiv.style.backgroundColor = "#fff0f0";
    }

    let html = `<strong>${data.sender}:</strong> `;

    // CHECK FOR ENCRYPTED LINK
    if (data.encrypted_link) {
        // If a link exists, show a "Download/View" button
        html += `<span class="file-box" style="display:block; margin-top:5px; background:#e3f2fd; padding:8px; border-radius:4px;">
                    <a href="#" onclick="decryptAndRedirect('${data.encrypted_link}')" style="color:#007bff; font-weight:bold; text-decoration:none;">
                        üìÅ Click to Access: ${data.file_name}
                    </a>
                 </span>`;
    } else {
        html += `<span>${data.message}</span>`;
    }

    if (data.profanity_warning) {
        html += ` <small style="color:red;">‚ö†Ô∏è AI Flagged</small>`;
    }

    msgDiv.innerHTML = html;
    chatLog.appendChild(msgDiv);
    chatLog.scrollTop = chatLog.scrollHeight;
};;

    // Form Handling
    document.querySelector('#chat-message-submit').onclick = () => {
        const input = document.querySelector('#chat-message-input');
        chatSocket.send(JSON.stringify({ 'message': input.value }));
        input.value = '';
    };

    document.getElementById('upload-form').onsubmit = async function(e) {
        e.preventDefault();
        const msgBox = document.getElementById('message-box');
        msgBox.textContent = 'AI is scanning file...';
        msgBox.style.color = 'blue';

        const formData = new FormData(this);
        formData.append('room_name', roomName);

        const response = await fetch('/chat/upload_file/', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });
        const result = await response.json();

        if (result.success) {
            msgBox.textContent = result.profanity_warning ? '‚ö†Ô∏è Flagged by AI, but sent.' : '‚úÖ Clean file sent.';
            msgBox.style.color = result.profanity_warning ? 'red' : 'green';
        } else {
            msgBox.textContent = 'Upload failed.';
            msgBox.style.color = 'red';
        }
    };
</script>
</body>
</html>